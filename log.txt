Cours 1 (14.09.2020)
1. Mise en place du raspberry pi 4b

__déballage raspberry pi 4b

1. déballage raspberry pi 4b
2. téléchargement de l'OS xbian depuis le site https://xbian.org/getxbian/ (version Raspberry Pi 4B)
3. suivi des instructions d'installation sur le site www.okdo.com/getstarted
3.1 collage des heatsinks sur le raspberry
3.2 insertion du raspberry dans son boitier
4. flash de la carte sd avec raspberry pi imager (commande 'dd' pour le faire manuellement sur un sys. unix)
5. insertion de la carte micro sd dans le raspberry
6. branchement du cable hdmi dans le port 'hdmi 0' du raspberry et démarrage de celui-ci
7. boot xbian 
8. configuration de clavier en azerty
8.1 connexion du raspberry à internet via wifi (https://docs.dataplicity.com/docs/get-pi-connected-to-the-internet)
8.2 sudo apt-get update pour mettre à jour les paquets
8.3 changement du layout du clavier (https://sudoxanthippe.wordpress.com/2012/07/27/changing-keyboard-layout-on-raspbian-11-2/)

installation du service SSH sur le raspberry
9.1 commande 'sudo apt-get install ssh'
9.2 commande 'sudo service ssh restart'

Connexion:
10. dans le terminal distant, taper la commande 'ssh xbian@addrIpDuRaspberry' ("xbian" etant le nom de l'utilisateur)

connexion via cable ethernet (linux - sans root)
- impossible de hardcoder une addr static dans le linux sans root alors on utilise la dernière addresse à laquelle l'ordi s'est connecté
- configuration et mise en place d'une addr static dans kodi (menu - outils xbian - system) changer le type en static
et hard coder IP Adress puis sauver les changements
ex: raspberrypi: 192.168.5.71
    mach. linux: 192.168.5.70
depuis la mach. linux taper la commande nmap -sP 192.168.5.0/24
normalement l'addr 192.168.5.71 sera affichée et c'est celle du raspberry
se connecter avec sh via ssh xbian@192.168.5.71

enlever le bouton exit du GUI kodi
- aller dans /usr/local/share/kodi/addons/skin.estuary/xml et éditer le fichier DialogButtonMenu.xml (faire une sauvegarde du fichier avant modif.)
- remplacer la ligne (en dessous de <onclick>Quit()</onclick>) <visible>System.ShowExitButton</visible> par <visible>no</visible>


Cours 2 (21.09.2020)
- exécuter un script a une heure précise avec 'cron' dans '~/scripts/cron.sh'
- connexion du disque dur au raspberry
- installer les commandes tar, ffmpeg, youtube-dl, Git, wGet (tar et wget, déjà installés)
- exécuter un script qui sort a l'écran la temperature/fréquence cpu du raspberry '~/scripts/diag.sh'



étape 1:
1.1 création du script
1.1.1 création du dossier 'scripts' dans ~/ (commande #mkdir scripts)
1.1.2 création du fichier 'cron.sh' avec le contenu suivant:
#!/bin/bash
echo 'exécution de la commande #ls -l'
ls -l
1.1.3 autorisation de l'exécuter pour tt le monde, commande #chmod +x cron.sh
1.1.4 test pour voir si le script fonctionne, commande #./cron.sh

1.2 mise en place du démon 'cron'
1.2.1 ajout du script à l'exécution de cron => #crontab -e 
ajouter cette ligne en fin
* * * * * /root/scripts/cron.sh >> /root/scripts/cron.log 
(s'exécute ttes les minutes)

pour débugger une commande dans cron qui ne donne aucun résultat, on peut la débugger en terminant la commande par: 'commande > ~/err.txt 2>&1'

1.2.2 exécution du script à 03h00 + sleep qques sec. pour éviter une surcharge sur le repository du prof

- installer git 
#apt-get update 
et 
#apt-get install git
- faire attendre une durée aléatoire entre 0 et 3600 secondes => #sleep $((RANDOM % 3600))
le (&& permet d'exécuter la commande suivante uniquement si la précédente est réussie)

changer l'heure et la mettre à celle de bruxelles => #ln -sf /usr/share/zoneinfo/Europe/Brussels /etc/localtime
(https://www.systutorials.com/linux-setting-date-time-and-timezone/)

Pour exécuter un pull a partir d'un répertoire différent:
#git -C /root/scripts/git_scripts/pje-f-raspberry-pi-4b/ pull

Le problème c'est qu'il va nous demander à chaque fois notre username et passwd donc après avoir lancé la commande #git config --global credential.helper store
il faudra de nouveau exéctuer #git -C /root/scripts/git_scripts/pje-f-raspberry-pi-4b/ pull https://gitlab.univ-lille.fr/pierre.michiels.etu/pje-f-raspberry-pi-4b.git
là il nous demandera pour la dernière fois notre username et passwd (https://stackoverflow.com/questions/35942754/how-to-save-username-and-password-in-git-gitextension)

connexion au repository via SSH: https://www.youtube.com/watch?v=QaO9aWy4rmc

le premier script 'runit.sh' ressemble à ceci:
#!/bin/bash

echo "$(date) - alive $rpi_name" >> /log/workload.log

$rpi_name est une variable qui représente le nom hostname du raspberry, on l'ajoute en tant que variable dans #crontab -e

ligne a ajouter apres avoir lancé la commande #crontab -e 
=> 
GIT_PATH=/root/scripts/git_scripts/pje-f-raspberry-pi-4b
CORRECT_GIT_PATH=/root/scripts/git_scripts/pje-f
rpi_name=michiels_raspberry_4b
1 3 * * * git -C $CORRECT_GIT_PATH checkout pmichiels && git -C $CORRECT_GIT_PATH pull && bash $CORRECT_GIT_PATH/runit/runit.sh && git -C $CORRECT_GIT_PATH add . && git -C $CORRECT_GIT_PATH commit -m "commit `date +\%d-\%m-\%Y` - `date +\%H:\%M:\%S` michiels" && git -C $CORRECT_GIT_PATH push origin pmichiels



et avec le paragraphe de '#' on ajoute les variables suivantes:
rpi_name=michiels_raspberry_4b
CORRECT_GIT_PATH=/root/scripts/git_scripts/pje-f


2.0 connexion du disque dur au raspberry et créer les dossiers '/media/usb/Films' , '/media/usb/Series' , '/media/usb/video-clips'.
raspberry le monte automatiquement
commande pour lister les disques => #lsblk
/media/sda est le disque dur
/media/sda1 est la partition donc il faut créer les dossiers dans /media/sda1 qui nous mène dans ce cas ci au dossier '/media/usb0'
commande pour démonter le disque 'sda1' => #umount -l /dev/sda1 (vérifier avant si c'est bien 'sda1' avec la commande #lsblk)


3.0 exécuter un script qui sort a l'écran la temperature/fréquence cpu du raspberry '~/scripts/diag.sh'
- installation du paquet 'lm-sensors' => #apt-get install lm-sensors
- pour retirer une string de l'ouput de la commande #sensors => #sensors | grep -oP '(?<=temp1:).*'
(https://unix.stackexchange.com/questions/393948/how-to-search-and-extract-string-from-command-output)

sinon, pour la frequence et le voltage
freq=$(vcgencmd measure_clock arm)
volt=$(vcgencmd measure_volts)


Cours 3 (28.09.2020)
- modifier l'interface, coté navigation (partie gauche)
il faut faire en sorte qu'il n'y a plus que les catégories film, series, TV et météo restent (supprimer ou créer les catégories manquantes)
il faut en fait avoir un ou plusieurs fichiers xml (qui sont sur un repository) qui représentent le menu qu'on a envie d'avoir et un script qui git pull et remplace les fichiers de l'ancien menu et les replacent avec les fichiers xml du repository.

Pour faciliter le raffraichissement de la page, on utilise des raccourcis inscrits dans le fichier keymap.xml, (à créer et à mettre dans /home/xbian/.kodi/userdata/keymaps)
https://kodi.wiki/view/Archive:Foundation



Pour afficher plus que les catégories film, series, TV et météo, il faut aller dans le fichier Home.xml (/usr/local/share/kodi/addons/skin.estuary/xml/Home.xml) et mettre en commentaire les balises <item> et leur contenu à partir de la ligne avec "<control type="fixedlist" id="9000">"
(voir point 6 - https://kodi.wiki/view/Estuary_Modification)

- Il faut ajouter un addon pour la catégorie TV addon franceTV 
Il faut donc le télécharger depuis kodi et son dossier dans le système unix se trouve à: /home/xbian/.kodi/addons/plugin.video.francetv
(après l'exercice, j'ai appris qu'il m'est impossible de transferer l'addon france tv de la catégorie 'video' vers la catégorie 'TV')



- il faut aussi rediriger ce que le script du prof télécharge dans le disque dur /media/usb0/Films ou encore /media/usb0/Series etc.
comment faire:
exécuter les commandes=>

#wget -q https://www.grimaud.ovh/pjef/Films.tar -O tmp.tar >> logs/workload.log
#tar -xvf tmp.tar >> logs/workload.log
#rm tmp.tar >> logs/workload.log
#wget -q https://www.grimaud.ovh/pjef/Series.tar -O tmp.tar >> logs/workload.log
#tar -xvf tmp.tar >> logs/workload.log
#rm tmp.tar >> logs/workload.log

puis déplacer les dossiers Films et Series dans le disque dur (/media/usb0/)

dans chaque dossier on a un fichier mkv de taille 0 octet
un fichier nfo qui faudra mettre a jour qui contient ttes les infos du film
*-poster.jpg qui est la jaquette
*-fontart.jpg qui est l'image de fond
*actors ???
et en dernier, il faut télécharger de youtube le trailer du film avec la commande youtube-dl
j'ai appris que kodi peut repérer le trailer localement si celui ci à son nom qui se termine par '*-trailer.extension'
https://forum.kodi.tv/showthread.php?tid=164443
il faut ensuite apres avoir téléchargé le trailer, le convertir en fichier mkv avec la commande ffmpeg

Pour le téléchargement des trailers:
installer le paquet curl pour récuperer un résultat json de l'api et jq pour pouvoir retirer des informations a partir du résultat json.
- Créer un script bash:
-- qui va récuperer un fichier json qui contient les données (venant de l'API youtube) pour chaque film du dossier Films
-- récupère l'id de la 1ere video trouvée via la commande 'jq'
-- télécharge la video (via la commande 'youtube-dl, a installer depuis le dépot officiel car la version via 'apt' est obselète) 
avec le lien http qui contient donc l'id de la video youtube
https://doc.ubuntu-fr.org/youtube-dl
-- 

Il faut récupérer une clé API google pour pouvoir utiliser l'API "YouTube Data API" après avoir aussi activé cette API dans le projet google

Après discussion avec le professeur, il n'est pas obligatoire de passer par une API, les liens de bande d'annonce se trouvent deja dans le fichier .nfo du dossier du film.

Pour récupérer le string spécifique dans le fichier .nfo:
https://stackoverflow.com/questions/21077882/pattern-to-get-string-between-two-specific-words-characters-using-grep

Cours 4 (05.10.2020)
terminer le cours 3
- afficher les catégories film, series, TV et météo (TV devient en fait la catégorie favoris et il aura le logo de la cat. TV et toutes les chaines du plugin franceTV)

faire de la surveillance video et faire en sorte que la caméra s'active et enregistre des qu'il y a du mouvement.
Possibilité de voir en direct depuis la catégorie 'favorites'
https://opendomotech.com/videosurveillance-avec-raspberry-pi-et-motion/







